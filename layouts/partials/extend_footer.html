{{/* layouts/partials/extend_footer.html */}}

{{/* =========================
   1) Page Views (Busuanzi) - load ONCE
   ========================= */}}
{{ if .Site.Params.showPageViews }}
  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
{{ end }}

{{/* =========================
   2) Recent: fan <-> grid switch (ONLY ONCE)
   ========================= */}}
<script>
(function () {
  const root = document.querySelector("#yl-recent");
  if (!root) return;

  const body = root.querySelector(".yl-recent-body");
  const sentinel = root.querySelector("#yl-recent-sentinel");
  if (!body || !sentinel) return;

  if (body.classList.contains("force-grid")) {
    body.setAttribute("data-mode", "grid");
    return;
  }

  if (body.__ylRecentObserverAttached) return;
  body.__ylRecentObserverAttached = true;

  const io = new IntersectionObserver(
    ([entry]) => {
      if (body.classList.contains("force-grid")) {
        body.setAttribute("data-mode", "grid");
        return;
      }
      body.setAttribute("data-mode", entry.isIntersecting ? "fan" : "grid");
    },
    { threshold: 0.1 }
  );

  io.observe(sentinel);
})();
</script>

{{/* =========================
   3) Home Instant Search (index.json + Fuse.js)
   ========================= */}}
{{ $homeSearch := resources.Get "js/yanlunai-home-search.js" | minify | fingerprint }}
<script defer src="{{ $homeSearch.RelPermalink }}"></script>

{{/* =========================
   4) Search Page Query Bridge
   - Make /search/?q=xxx populate the search input
   ========================= */}}
{{ $searchBridge := resources.Get "js/yanlunai-search-bridge.js" | minify | fingerprint }}
<script defer src="{{ $searchBridge.RelPermalink }}"></script>